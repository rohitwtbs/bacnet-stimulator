<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BACnet Stimulator UI</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    h1 { color: #2c3e50; }
    table { border-collapse: collapse; width: 60%; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
    th { background: #f4f4f4; }
  </style>
</head>
<body>
  <h1>Simulated BACnet Devices</h1>
  <div style="display:flex;gap:40px;align-items:flex-start;">
    <div>
      <h3>Floor Map</h3>
      <div id="map-container" style="position:relative;width:600px;height:400px;border:1px solid #aaa;background:#eee;">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Simple_house_floorplan.svg/600px-Simple_house_floorplan.svg.png" alt="Floor Map" style="width:600px;height:400px;display:block;">
        <div id="map-markers" style="position:absolute;top:0;left:0;width:600px;height:400px;"></div>
      </div>
    </div>
    <div>
      <table id="devices-table">
        <thead>
          <tr>
            <th></th>
            <th>Device ID</th>
            <th>Address</th>
            <th>Port</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script>
    let lastDevices = [];
    let expanded = {};

    function toggleExpand(deviceId) {
      expanded[deviceId] = !expanded[deviceId];
      renderDevices(lastDevices);
    }

    function renderDevices(devices) {
      const tbody = document.querySelector('#devices-table tbody');
      tbody.innerHTML = '';
      devices.forEach(dev => {
        const isOpen = expanded[dev.deviceId];
        const row = document.createElement('tr');
        row.className = 'device-row';
        row.style.cursor = 'pointer';
        row.onclick = () => toggleExpand(dev.deviceId);
        row.innerHTML = `
          <td style="width:30px;text-align:center;">${dev.objects && dev.objects.length > 0 ? (isOpen ? '▼' : '►') : ''}</td>
          <td>${dev.deviceId}</td>
          <td>${dev.address}</td>
          <td>${dev.port}</td>
        `;
        tbody.appendChild(row);
        // Add objects as a nested table if expanded
        if (isOpen && dev.objects && dev.objects.length > 0) {
          const objRow = document.createElement('tr');
          const objCell = document.createElement('td');
          objCell.colSpan = 4;
          let objTable = '<table style="margin:10px 0 10px 40px;width:auto;background:#f9f9f9;">';
          objTable += '<thead><tr><th>Type</th><th>Name</th><th>Present Value</th></tr></thead><tbody>';
          dev.objects.forEach(obj => {
            objTable += `<tr><td>${obj.type}</td><td>${obj.name}</td><td>${obj.presentValue}</td></tr>`;
          });
          objTable += '</tbody></table>';
          objCell.innerHTML = objTable;
          objRow.appendChild(objCell);
          tbody.appendChild(objRow);
        }
      });

      // Render device markers on the map
      const markerLayer = document.getElementById('map-markers');
      markerLayer.innerHTML = '';
      devices.forEach(dev => {
        if (typeof dev.x === 'number' && typeof dev.y === 'number') {
          const marker = document.createElement('div');
          marker.style.position = 'absolute';
          marker.style.left = (dev.x - 10) + 'px';
          marker.style.top = (dev.y - 10) + 'px';
          marker.style.width = '20px';
          marker.style.height = '20px';
          marker.style.background = '#3498db';
          marker.style.borderRadius = '50%';
          marker.style.display = 'flex';
          marker.style.alignItems = 'center';
          marker.style.justifyContent = 'center';
          marker.style.color = '#fff';
          marker.style.fontWeight = 'bold';
          marker.style.cursor = 'pointer';
          marker.title = `Device ${dev.deviceId}`;
          marker.innerText = dev.deviceId;
          marker.onclick = (e) => {
            e.stopPropagation();
            expanded[dev.deviceId] = !expanded[dev.deviceId];
            renderDevices(devices);
          };
          markerLayer.appendChild(marker);
        }
      });
    }

    async function fetchDevices() {
      const res = await fetch('/api/devices');
      const devices = await res.json();
      lastDevices = devices;
      renderDevices(devices);
    }
    fetchDevices();
    setInterval(fetchDevices, 3000); // Refresh every 3 seconds
  </script>
</body>
</html>
